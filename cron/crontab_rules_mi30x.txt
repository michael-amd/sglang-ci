# machine is at CT time
#
# REQUIRED ENVIRONMENT VARIABLES - Set these before installing cron jobs:
# - SGL_BENCHMARK_CI_DIR: Path to sgl_benchmark_ci directory (e.g., /home/user/sgl_benchmark_ci)
# - GROK_MODEL_PATH: Path to Grok model (e.g., /data/grok-1-W4A8KV8)
# - DEEPSEEK_MODEL_PATH: Path to DeepSeek model (e.g., /data/deepseek-ai/DeepSeek-V3)
# - HARDWARE_TYPE: Hardware type for all jobs (mi30x, mi35x)
# - TEAMS_WEBHOOK_URL: Teams webhook URL for notifications
# - GITHUB_REPO: Repository identifier (owner/repo) for uploading logs and plots
# - GITHUB_TOKEN: Personal access token with push access to the repository
#
# Environment variables (set these before running crontab):
SGL_BENCHMARK_CI_DIR="/mnt/raid/michael/sglang-ci"
GROK_MODEL_PATH="/mnt/raid/models/huggingface/amd--grok-1-W4A8KV8"
GROK2_MODEL_PATH="/mnt/raid/models/huggingface/grok-2"
GROK2_TOKENIZER_PATH="/mnt/raid/models/huggingface/alvarobartt--grok-2-tokenizer"
DEEPSEEK_MODEL_PATH="/mnt/raid/models/huggingface/deepseek-ai/DeepSeek-V3-0324"
HARDWARE_TYPE="mi30x"

# Public Teams webhook left empty by default â€“ fill in to enable alerts
TEAMS_WEBHOOK_URL=""

# GitHub repository configuration (fill in to enable log/plot uploads)
GITHUB_REPO="michael-amd/sglang-ci-data"
GITHUB_TOKEN=""

# 10 PM PT (0 AM CT) - Grok 2 online benchmark + Teams notifications
0 0 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && bash perf_nightly.sh --model=grok2 --model-path="$GROK2_MODEL_PATH" --tokenizer-path="$GROK2_TOKENIZER_PATH" --mode=online --hardware="$HARDWARE_TYPE" --teams-webhook-url="$TEAMS_WEBHOOK_URL" > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/grok2_nightly_online.log 2>&1 && bash cron/github_log_upload.sh

# 0 AM PT (2 AM CT) - DeepSeek online with DP attention checking + Teams notifications
0 2 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && bash perf_nightly.sh --model=deepseek --model-path="$DEEPSEEK_MODEL_PATH" --mode=online --hardware="$HARDWARE_TYPE" --check-dp-attention --teams-webhook-url="$TEAMS_WEBHOOK_URL" > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/deepseek_dp_attention.log 2>&1 && bash cron/github_log_upload.sh

# 0:10 AM PT (2:10 AM CT) - DeepSeek online with torch compile optimization + Teams notifications
10 2 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && bash perf_nightly.sh --model=deepseek --model-path="$DEEPSEEK_MODEL_PATH" --mode=online --hardware="$HARDWARE_TYPE" --enable-torch-compile --teams-webhook-url="$TEAMS_WEBHOOK_URL" > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/deepseek_torch_compile.log 2>&1 && bash cron/github_log_upload.sh

# 0:50 AM PT (2:50 AM CT) - DeepSeek online with DP attention + torch compile + Teams notifications
50 2 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && bash perf_nightly.sh --model=deepseek --model-path="$DEEPSEEK_MODEL_PATH" --mode=online --hardware="$HARDWARE_TYPE" --check-dp-attention --enable-torch-compile --teams-webhook-url="$TEAMS_WEBHOOK_URL" > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/deepseek_dp_attention_torch_compile.log 2>&1 && bash cron/github_log_upload.sh

# 1:30 AM PT (3 AM CT) - DeepSeek online benchmark + Teams notifications
30 3 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && bash perf_nightly.sh --model=deepseek --model-path="$DEEPSEEK_MODEL_PATH" --mode=online --hardware="$HARDWARE_TYPE" --teams-webhook-url="$TEAMS_WEBHOOK_URL" > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/deepseek_nightly_online.log 2>&1 && bash cron/github_log_upload.sh

# 6 AM PT (8 AM CT) - Grok online benchmark + Teams notifications
0 8 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && bash perf_nightly.sh --model=grok --model-path="$GROK_MODEL_PATH" --mode=online --hardware="$HARDWARE_TYPE" --teams-webhook-url="$TEAMS_WEBHOOK_URL" > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/grok_nightly.log 2>&1 && bash cron/github_log_upload.sh

# 9 AM PT (11 AM CT) - Docker image availability check with Teams notifications
0 11 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && TEAMS_WEBHOOK_URL="$TEAMS_WEBHOOK_URL" bash nightly_image_check.sh > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/docker_image_check.log 2>&1 && bash cron/github_log_upload.sh

# 9:05 AM PT (11:05 AM CT) - Unit test nightly run with Teams notifications
5 11 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && bash test_nightly.sh --hardware="$HARDWARE_TYPE" --teams-webhook-url="$TEAMS_WEBHOOK_URL" > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/test_nightly.log 2>&1 && bash cron/github_log_upload.sh

# 9:30 AM PT (11:30 AM CT) - Sanity check with latest nightly image + Teams alert
30 11 * * * cd "$SGL_BENCHMARK_CI_DIR" && mkdir -p cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d) && bash perf_nightly.sh --mode=sanity --hardware="$HARDWARE_TYPE" --sanity-trials=3 --teams-webhook-url="$TEAMS_WEBHOOK_URL" > cron/cron_log/$HARDWARE_TYPE/$(date +\%Y\%m\%d)/sanity_check_nightly.log 2>&1 && bash cron/github_log_upload.sh
