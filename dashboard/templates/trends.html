{% extends "base.html" %}

{% block title %}CI Trends{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4"><i class="bi bi-graph-up-arrow"></i> CI Trends</h1>
        <p class="lead">Historical trends and analytics for CI performance</p>
    </div>
</div>

<!-- Controls -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <label for="hardwareSelect" class="form-label fw-bold">Hardware:</label>
                <select class="form-select" id="hardwareSelect">
                    <option value="mi30x">MI30X</option>
                    <option value="mi35x">MI35X</option>
                </select>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <label for="daysSelect" class="form-label fw-bold">Time Range:</label>
                <select class="form-select" id="daysSelect">
                    <option value="7" selected>Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                </select>
                <small class="text-muted d-block mt-1">⚠️ Note: Larger time ranges may take longer to load</small>
            </div>
        </div>
    </div>
</div>

<!-- Loading Progress Indicator -->
<div class="row mb-4" id="loading-progress" style="display: none;">
    <div class="col">
        <div class="card border-primary">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1" id="loading-message">Loading trends data...</h6>
                        <div class="progress" style="height: 20px;">
                            <div id="loading-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                 role="progressbar" style="width: 0%">
                                <span id="loading-percentage">0%</span>
                            </div>
                        </div>
                        <small class="text-muted" id="loading-detail">Preparing to fetch data...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overall Trends -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Overall Pass Rate Trend</h5>
            </div>
            <div class="card-body">
                <div id="pass-rate-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="pass-rate-chart" style="display: none;">
                    <canvas id="passRateCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Status Distribution -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Task Status Distribution</h5>
            </div>
            <div class="card-body">
                <div id="status-distribution-loading" class="text-center py-5">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="status-distribution-chart" style="display: none;">
                    <canvas id="statusDistCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Benchmark-Specific Trends -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> GSM8K Accuracy Trends</h5>
            </div>
            <div class="card-body">
                <div id="accuracy-loading" class="text-center py-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="accuracy-chart" style="display: none;">
                    <canvas id="accuracyCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Runtime Trends</h5>
            </div>
            <div class="card-body">
                <div id="runtime-loading" class="text-center py-5">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="runtime-chart" style="display: none;">
                    <canvas id="runtimeCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Individual Test History -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0"><i class="bi bi-list-check"></i> Individual Test History</h5>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" id="testSelect">
                            <option value="">Select a test...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="test-history-info" class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Select a test from the dropdown above to view its pass/fail history over time.
                </div>
                <div id="test-history-loading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="test-history-chart" style="display: none;">
                    <canvas id="testHistoryCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let passRateChart = null;
    let statusDistChart = null;
    let accuracyChart = null;
    let runtimeChart = null;
    let testHistoryChart = null;
    let currentTestHistory = null;

    function showLoadingProgress() {
        document.getElementById('loading-progress').style.display = 'block';
        document.getElementById('loading-message').textContent = 'Loading trends data...';
        document.getElementById('loading-detail').textContent = 'Fetching historical CI results...';
        updateProgressBar(0);
    }

    function updateProgressBar(percent, message = '') {
        const progressBar = document.getElementById('loading-progress-bar');
        const percentage = document.getElementById('loading-percentage');
        const detail = document.getElementById('loading-detail');

        progressBar.style.width = percent + '%';
        percentage.textContent = Math.round(percent) + '%';

        if (message) {
            detail.textContent = message;
        }
    }

    function hideLoadingProgress() {
        document.getElementById('loading-progress').style.display = 'none';
    }

    function loadTrends() {
        const hardware = document.getElementById('hardwareSelect').value;
        const days = document.getElementById('daysSelect').value;

        // Show progress indicator
        showLoadingProgress();

        // Simulate progress during fetch
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += 5;
                updateProgressBar(progress, `Fetching data from GitHub (${days} days)...`);
            }
        }, 500);

        const startTime = Date.now();

        // Fetch both trends and test history
        Promise.all([
            fetch(`/api/trends/${hardware}?days=${days}`).then(r => r.json()),
            fetch(`/api/test-history/${hardware}?days=${days}`).then(r => r.json())
        ])
            .then(([trendsData, historyData]) => {
                clearInterval(progressInterval);
                updateProgressBar(95, 'Processing data...');

                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                updateProgressBar(100, `Completed in ${elapsed}s`);

                setTimeout(() => {
                    hideLoadingProgress();
                    renderPassRateTrend(trendsData.trends);
                    renderStatusDistribution(trendsData.trends);
                    renderAccuracyTrends(trendsData.trends);
                    renderRuntimeTrends(trendsData.trends);
                    loadTestHistory(historyData);
                }, 500);
            })
            .catch(error => {
                clearInterval(progressInterval);
                hideLoadingProgress();
                console.error('Error loading trends:', error);

                // Show error message
                document.getElementById('loading-progress').style.display = 'block';
                document.getElementById('loading-message').textContent = 'Error loading trends';
                document.getElementById('loading-detail').textContent = error.message;
                updateProgressBar(0);
            });
    }

    function loadTestHistory(data) {
        currentTestHistory = data.test_history;

        // Populate test selector dropdown
        const testSelect = document.getElementById('testSelect');
        testSelect.innerHTML = '<option value="">Select a test...</option>';

        // Sort tests alphabetically
        const testNames = Object.keys(currentTestHistory).sort();

        // Group tests by category
        const benchmarks = testNames.filter(t => t.includes('Benchmark'));
        const tests = testNames.filter(t => t.includes('Test') && !t.includes('Sanity'));
        const sanity = testNames.filter(t => t.includes('Sanity'));
        const checks = testNames.filter(t => t.includes('Check') || t.includes('Unit') || t.includes('PD'));

        // Add optgroups
        if (benchmarks.length > 0) {
            const benchmarkGroup = document.createElement('optgroup');
            benchmarkGroup.label = 'Benchmarks';
            benchmarks.forEach(test => {
                const option = document.createElement('option');
                option.value = test;
                option.textContent = test;
                benchmarkGroup.appendChild(option);
            });
            testSelect.appendChild(benchmarkGroup);
        }

        if (tests.length > 0) {
            const testGroup = document.createElement('optgroup');
            testGroup.label = 'Integration Tests';
            tests.forEach(test => {
                const option = document.createElement('option');
                option.value = test;
                option.textContent = test;
                testGroup.appendChild(option);
            });
            testSelect.appendChild(testGroup);
        }

        if (sanity.length > 0) {
            const sanityGroup = document.createElement('optgroup');
            sanityGroup.label = 'Sanity Checks';
            sanity.forEach(test => {
                const option = document.createElement('option');
                option.value = test;
                option.textContent = test;
                testGroup.appendChild(option);
            });
            testSelect.appendChild(sanityGroup);
        }

        if (checks.length > 0) {
            const checkGroup = document.createElement('optgroup');
            checkGroup.label = 'Validation Checks';
            checks.forEach(test => {
                const option = document.createElement('option');
                option.value = test;
                option.textContent = test;
                checkGroup.appendChild(option);
            });
            testSelect.appendChild(checkGroup);
        }
    }

    function renderTestHistory(testName) {
        if (!currentTestHistory || !currentTestHistory[testName]) {
            return;
        }

        document.getElementById('test-history-info').style.display = 'none';
        document.getElementById('test-history-loading').style.display = 'none';
        document.getElementById('test-history-chart').style.display = 'block';

        const testData = currentTestHistory[testName];
        const ctx = document.getElementById('testHistoryCanvas').getContext('2d');

        if (testHistoryChart) {
            testHistoryChart.destroy();
        }

        // Convert status to numeric values for display
        // pass = 1, fail = -1, unknown = 0, not_run = null
        const statusValues = testData.status.map(s => {
            if (s === 'pass') return 1;
            if (s === 'fail') return -1;
            if (s === 'unknown') return 0;
            return null;
        });

        // Create background colors based on status
        const backgroundColors = testData.status.map(s => {
            if (s === 'pass') return 'rgba(25, 135, 84, 0.8)';
            if (s === 'fail') return 'rgba(220, 53, 69, 0.8)';
            if (s === 'unknown') return 'rgba(255, 193, 7, 0.8)';
            return 'rgba(108, 117, 125, 0.3)';
        });

        testHistoryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: testData.dates,
                datasets: [{
                    label: testName,
                    data: statusValues,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(c => c.replace('0.8', '1').replace('0.3', '0.6')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        min: -1.5,
                        max: 1.5,
                        ticks: {
                            callback: function(value) {
                                if (value === 1) return 'PASS';
                                if (value === -1) return 'FAIL';
                                if (value === 0) return 'UNKNOWN';
                                return '';
                            },
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const status = testData.status[idx];
                                const details = testData.details[idx];

                                let lines = [`Status: ${status.toUpperCase()}`];

                                if (details.runtime) {
                                    lines.push(`Runtime: ${details.runtime}`);
                                }
                                if (details.gsm8k_accuracy !== undefined) {
                                    lines.push(`GSM8K Accuracy: ${details.gsm8k_accuracy}%`);
                                }
                                if (details.accuracy !== undefined) {
                                    lines.push(`Accuracy: ${details.accuracy}`);
                                }
                                if (details.error) {
                                    lines.push(`Error: ${details.error}`);
                                }

                                return lines;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderPassRateTrend(trends) {
        document.getElementById('pass-rate-loading').style.display = 'none';
        document.getElementById('pass-rate-chart').style.display = 'block';

        const ctx = document.getElementById('passRateCanvas').getContext('2d');

        if (passRateChart) {
            passRateChart.destroy();
        }

        passRateChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trends.dates,
                datasets: [{
                    label: 'Pass Rate (%)',
                    data: trends.pass_rate,
                    borderColor: 'rgba(25, 135, 84, 1)',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Pass Rate: ' + context.parsed.y + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function renderStatusDistribution(trends) {
        document.getElementById('status-distribution-loading').style.display = 'none';
        document.getElementById('status-distribution-chart').style.display = 'block';

        const ctx = document.getElementById('statusDistCanvas').getContext('2d');

        if (statusDistChart) {
            statusDistChart.destroy();
        }

        statusDistChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: trends.dates,
                datasets: [
                    {
                        label: 'Passed',
                        data: trends.passed_tasks,
                        backgroundColor: 'rgba(25, 135, 84, 0.7)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Failed',
                        data: trends.failed_tasks,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function renderAccuracyTrends(trends) {
        document.getElementById('accuracy-loading').style.display = 'none';
        document.getElementById('accuracy-chart').style.display = 'block';

        const ctx = document.getElementById('accuracyCanvas').getContext('2d');

        if (accuracyChart) {
            accuracyChart.destroy();
        }

        const datasets = [];
        const colors = [
            'rgba(13, 110, 253, 1)',
            'rgba(25, 135, 84, 1)',
            'rgba(255, 193, 7, 1)'
        ];

        let colorIndex = 0;
        for (const [taskName, taskData] of Object.entries(trends.benchmarks)) {
            if (taskData.gsm8k_accuracy.some(v => v !== null)) {
                datasets.push({
                    label: taskName,
                    data: taskData.gsm8k_accuracy,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length].replace('1)', '0.1)'),
                    fill: false,
                    tension: 0.4,
                    spanGaps: true
                });
                colorIndex++;
            }
        }

        accuracyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trends.dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.parsed.y !== null) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                                return null;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderRuntimeTrends(trends) {
        document.getElementById('runtime-loading').style.display = 'none';
        document.getElementById('runtime-chart').style.display = 'block';

        const ctx = document.getElementById('runtimeCanvas').getContext('2d');

        if (runtimeChart) {
            runtimeChart.destroy();
        }

        const datasets = [];
        const colors = [
            'rgba(13, 110, 253, 1)',
            'rgba(25, 135, 84, 1)',
            'rgba(255, 193, 7, 1)'
        ];

        let colorIndex = 0;
        for (const [taskName, taskData] of Object.entries(trends.benchmarks)) {
            if (taskData.runtime_minutes.some(v => v !== null)) {
                datasets.push({
                    label: taskName,
                    data: taskData.runtime_minutes,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length].replace('1)', '0.1)'),
                    fill: false,
                    tension: 0.4,
                    spanGaps: true
                });
                colorIndex++;
            }
        }

        runtimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trends.dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' min';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.parsed.y !== null) {
                                    const hours = Math.floor(context.parsed.y / 60);
                                    const minutes = context.parsed.y % 60;
                                    if (hours > 0) {
                                        return context.dataset.label + ': ' + hours + 'h ' + minutes + 'm';
                                    } else {
                                        return context.dataset.label + ': ' + minutes + 'm';
                                    }
                                }
                                return null;
                            }
                        }
                    }
                }
            }
        });
    }

    // Event listeners
    document.getElementById('hardwareSelect').addEventListener('change', loadTrends);
    document.getElementById('daysSelect').addEventListener('change', loadTrends);
    document.getElementById('testSelect').addEventListener('change', function() {
        const selectedTest = this.value;
        if (selectedTest) {
            renderTestHistory(selectedTest);
        } else {
            document.getElementById('test-history-info').style.display = 'block';
            document.getElementById('test-history-chart').style.display = 'none';
        }
    });

    // Load initial data
    loadTrends();
</script>
{% endblock %}
