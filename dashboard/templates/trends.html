{% extends "base.html" %}

{% block title %}CI Trends{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4"><i class="bi bi-graph-up-arrow"></i> CI Trends</h1>
        <p class="lead">Historical trends and analytics for CI performance</p>
    </div>
</div>

<!-- Controls -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <label for="hardwareSelect" class="form-label fw-bold">Hardware:</label>
                <select class="form-select" id="hardwareSelect">
                    <option value="mi30x">MI30X</option>
                    <option value="mi35x">MI35X</option>
                </select>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <label for="daysSelect" class="form-label fw-bold">Time Range:</label>
                <select class="form-select" id="daysSelect">
                    <option value="7" selected>Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="60">Last 60 days</option>
                    <option value="90">Last 90 days</option>
                </select>
                <small class="text-muted d-block mt-1">⚠️ Note: Larger time ranges may take 30-60 seconds to load</small>
            </div>
        </div>
    </div>
</div>

<!-- Loading Progress Indicator -->
<div class="row mb-4" id="loading-progress" style="display: none;">
    <div class="col">
        <div class="card border-primary">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1" id="loading-message">Loading trends data...</h6>
                        <div class="progress" style="height: 20px;">
                            <div id="loading-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                 role="progressbar" style="width: 0%">
                                <span id="loading-percentage">0%</span>
                            </div>
                        </div>
                        <small class="text-muted" id="loading-detail">Preparing to fetch data...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overall Trends -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Overall Pass Rate Trend</h5>
            </div>
            <div class="card-body">
                <div id="pass-rate-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="pass-rate-chart" style="display: none;">
                    <canvas id="passRateCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Task Status Distribution -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Task Status Distribution</h5>
            </div>
            <div class="card-body">
                <div id="status-distribution-loading" class="text-center py-5">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="status-distribution-chart" style="display: none;">
                    <canvas id="statusDistCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Benchmark-Specific Trends -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> GSM8K Accuracy Trends</h5>
            </div>
            <div class="card-body">
                <div id="accuracy-loading" class="text-center py-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="accuracy-chart" style="display: none;">
                    <canvas id="accuracyCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Runtime Trends</h5>
            </div>
            <div class="card-body">
                <div id="runtime-loading" class="text-center py-5">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="runtime-chart" style="display: none;">
                    <canvas id="runtimeCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let passRateChart = null;
    let statusDistChart = null;
    let accuracyChart = null;
    let runtimeChart = null;

    function showLoadingProgress() {
        document.getElementById('loading-progress').style.display = 'block';
        document.getElementById('loading-message').textContent = 'Loading trends data...';
        document.getElementById('loading-detail').textContent = 'Fetching historical CI results...';
        updateProgressBar(0);
    }

    function updateProgressBar(percent, message = '') {
        const progressBar = document.getElementById('loading-progress-bar');
        const percentage = document.getElementById('loading-percentage');
        const detail = document.getElementById('loading-detail');

        progressBar.style.width = percent + '%';
        percentage.textContent = Math.round(percent) + '%';

        if (message) {
            detail.textContent = message;
        }
    }

    function hideLoadingProgress() {
        document.getElementById('loading-progress').style.display = 'none';
    }

    function loadTrends() {
        const hardware = document.getElementById('hardwareSelect').value;
        const days = document.getElementById('daysSelect').value;

        // Show progress indicator
        showLoadingProgress();

        // Simulate progress during fetch
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += 5;
                updateProgressBar(progress, `Fetching data from GitHub (${days} days)...`);
            }
        }, 500);

        const startTime = Date.now();

        fetch(`/api/trends/${hardware}?days=${days}`)
            .then(response => {
                clearInterval(progressInterval);
                updateProgressBar(95, 'Processing data...');
                return response.json();
            })
            .then(data => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                updateProgressBar(100, `Completed in ${elapsed}s`);

                setTimeout(() => {
                    hideLoadingProgress();
                    renderPassRateTrend(data.trends);
                    renderStatusDistribution(data.trends);
                    renderAccuracyTrends(data.trends);
                    renderRuntimeTrends(data.trends);
                }, 500);
            })
            .catch(error => {
                clearInterval(progressInterval);
                hideLoadingProgress();
                console.error('Error loading trends:', error);

                // Show error message
                document.getElementById('loading-progress').style.display = 'block';
                document.getElementById('loading-message').textContent = 'Error loading trends';
                document.getElementById('loading-detail').textContent = error.message;
                updateProgressBar(0);
            });
    }

    function renderPassRateTrend(trends) {
        document.getElementById('pass-rate-loading').style.display = 'none';
        document.getElementById('pass-rate-chart').style.display = 'block';

        const ctx = document.getElementById('passRateCanvas').getContext('2d');

        if (passRateChart) {
            passRateChart.destroy();
        }

        passRateChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trends.dates,
                datasets: [{
                    label: 'Pass Rate (%)',
                    data: trends.pass_rate,
                    borderColor: 'rgba(25, 135, 84, 1)',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Pass Rate: ' + context.parsed.y + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function renderStatusDistribution(trends) {
        document.getElementById('status-distribution-loading').style.display = 'none';
        document.getElementById('status-distribution-chart').style.display = 'block';

        const ctx = document.getElementById('statusDistCanvas').getContext('2d');

        if (statusDistChart) {
            statusDistChart.destroy();
        }

        statusDistChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: trends.dates,
                datasets: [
                    {
                        label: 'Passed',
                        data: trends.passed_tasks,
                        backgroundColor: 'rgba(25, 135, 84, 0.7)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Failed',
                        data: trends.failed_tasks,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function renderAccuracyTrends(trends) {
        document.getElementById('accuracy-loading').style.display = 'none';
        document.getElementById('accuracy-chart').style.display = 'block';

        const ctx = document.getElementById('accuracyCanvas').getContext('2d');

        if (accuracyChart) {
            accuracyChart.destroy();
        }

        const datasets = [];
        const colors = [
            'rgba(13, 110, 253, 1)',
            'rgba(25, 135, 84, 1)',
            'rgba(255, 193, 7, 1)'
        ];

        let colorIndex = 0;
        for (const [taskName, taskData] of Object.entries(trends.benchmarks)) {
            if (taskData.gsm8k_accuracy.some(v => v !== null)) {
                datasets.push({
                    label: taskName,
                    data: taskData.gsm8k_accuracy,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length].replace('1)', '0.1)'),
                    fill: false,
                    tension: 0.4,
                    spanGaps: true
                });
                colorIndex++;
            }
        }

        accuracyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trends.dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.parsed.y !== null) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                                return null;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderRuntimeTrends(trends) {
        document.getElementById('runtime-loading').style.display = 'none';
        document.getElementById('runtime-chart').style.display = 'block';

        const ctx = document.getElementById('runtimeCanvas').getContext('2d');

        if (runtimeChart) {
            runtimeChart.destroy();
        }

        const datasets = [];
        const colors = [
            'rgba(13, 110, 253, 1)',
            'rgba(25, 135, 84, 1)',
            'rgba(255, 193, 7, 1)'
        ];

        let colorIndex = 0;
        for (const [taskName, taskData] of Object.entries(trends.benchmarks)) {
            if (taskData.runtime_minutes.some(v => v !== null)) {
                datasets.push({
                    label: taskName,
                    data: taskData.runtime_minutes,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length].replace('1)', '0.1)'),
                    fill: false,
                    tension: 0.4,
                    spanGaps: true
                });
                colorIndex++;
            }
        }

        runtimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trends.dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' min';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.parsed.y !== null) {
                                    const hours = Math.floor(context.parsed.y / 60);
                                    const minutes = context.parsed.y % 60;
                                    if (hours > 0) {
                                        return context.dataset.label + ': ' + hours + 'h ' + minutes + 'm';
                                    } else {
                                        return context.dataset.label + ': ' + minutes + 'm';
                                    }
                                }
                                return null;
                            }
                        }
                    }
                }
            }
        });
    }

    // Event listeners
    document.getElementById('hardwareSelect').addEventListener('change', loadTrends);
    document.getElementById('daysSelect').addEventListener('change', loadTrends);

    // Load initial data
    loadTrends();
</script>
{% endblock %}
