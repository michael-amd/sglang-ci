{% extends "base.html" %}

{% block title %}{{ hardware.upper() }} CI Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4">
            <i class="bi bi-cpu-fill"></i> {{ hardware.upper() }} CI Dashboard
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item active">{{ hardware.upper() }}</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Date Selector and Controls -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <label for="dateSelect" class="form-label fw-bold">Select Date:</label>
                <input type="date" class="form-control" id="dateSelect" value="">
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <label class="form-label fw-bold">Quick Actions:</label>
                <div class="btn-group d-block" role="group">
                    <a href="{{ url_for('plots_view', hardware=hardware) }}" class="btn btn-outline-primary">
                        <i class="bi bi-bar-chart-line"></i> View Plots
                    </a>
                    <a href="{{ url_for('trends') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-graph-up-arrow"></i> View Trends
                    </a>
                    <a href="https://github.com/{{ github_repo }}/tree/log/cron_log/{{ hardware }}"
                       target="_blank" class="btn btn-outline-info">
                        <i class="bi bi-folder2-open"></i> View Logs
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overall Summary Card -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-speedometer"></i> Overall Summary</h5>
            </div>
            <div class="card-body">
                <div id="overall-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading summary...</p>
                </div>
                <div id="overall-summary" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Task Results -->
<div class="row mb-4">
    <!-- Performance Benchmarks -->
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Performance Benchmarks</h5>
            </div>
            <div class="card-body">
                <div id="benchmarks-loading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                </div>
                <div id="benchmarks-tasks" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Integration Tests -->
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-plugin"></i> Integration Tests</h5>
            </div>
            <div class="card-body">
                <div id="integration-loading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                </div>
                <div id="integration-tasks" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Validation & Checks -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Validation & Checks</h5>
            </div>
            <div class="card-body">
                <div id="validation-loading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                </div>
                <div id="validation-tasks" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Sanity Check (Accuracy) -->
    <div class="col-lg-6 mb-3">
        <div class="card h-100">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Sanity Check (Accuracy)</h5>
            </div>
            <div class="card-body">
                <div id="sanity-loading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                </div>
                <div id="sanity-tasks" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    const hardware = '{{ hardware }}';
    const githubRepo = '{{ github_repo }}';

    // Initialize date picker
    const urlParams = new URLSearchParams(window.location.search);
    const urlDate = urlParams.get('date');
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = urlDate ? formatDateDisplay(urlDate) : today;

    function formatDateDisplay(dateStr) {
        // Convert YYYYMMDD to YYYY-MM-DD
        if (dateStr.length === 8) {
            return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
        }
        return dateStr;
    }

    function formatDateApi(dateStr) {
        // Convert YYYY-MM-DD to YYYYMMDD
        return dateStr.replace(/-/g, '');
    }

    // Task categories
    const taskCategories = {
        benchmarks: [
            'Grok Online Benchmark',
            'Grok 2 Online Benchmark',
            'DeepSeek Online Benchmark'
        ],
        integration: [
            'DeepSeek DP Attention Test',
            'DeepSeek Torch Compile Test',
            'DeepSeek DP+Torch Compile'
        ],
        validation: [
            'Unit Tests',
            'PD Disaggregation Tests',
            'Docker Image Check'
        ]
    };

    function loadData(dateStr) {
        const dateFormatted = formatDateApi(dateStr);

        fetch(`/api/summary/${hardware}/${dateFormatted}`)
            .then(response => response.json())
            .then(data => {
                renderOverallSummary(data);
                renderTaskCategory('benchmarks', data.task_results);
                renderTaskCategory('integration', data.task_results);
                renderTaskCategory('validation', data.task_results);
                renderSanityResults(data.sanity_results, dateFormatted);
            })
            .catch(error => {
                document.getElementById('overall-loading').style.display = 'none';
                document.getElementById('overall-summary').style.display = 'block';
                document.getElementById('overall-summary').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error loading data: ${error.message}
                    </div>
                `;
            });
    }

    function renderOverallSummary(data) {
        document.getElementById('overall-loading').style.display = 'none';
        document.getElementById('overall-summary').style.display = 'block';

        const stats = data.stats;
        const passRate = stats.tasks_run > 0
            ? ((stats.passed_tasks / stats.tasks_run) * 100).toFixed(1)
            : 0;

        const statusBadge = getStatusBadge(stats.overall_status);

        document.getElementById('overall-summary').innerHTML = `
            <div class="row">
                <div class="col-md-3 text-center">
                    <h2 class="text-success">${stats.passed_tasks}</h2>
                    <p class="text-muted">Passed</p>
                </div>
                <div class="col-md-3 text-center">
                    <h2 class="text-danger">${stats.failed_tasks}</h2>
                    <p class="text-muted">Failed</p>
                </div>
                <div class="col-md-3 text-center">
                    <h2 class="text-warning">${stats.unknown_tasks}</h2>
                    <p class="text-muted">Unknown</p>
                </div>
                <div class="col-md-3 text-center">
                    <h2 class="text-secondary">${stats.not_run}</h2>
                    <p class="text-muted">Not Run</p>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>Overall Status</h6>
                    ${statusBadge}
                </div>
                <div class="col-md-6">
                    <h6>Pass Rate</h6>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: ${passRate}%">
                            ${passRate}%
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderTaskCategory(category, taskResults) {
        const loadingId = `${category}-loading`;
        const tasksId = `${category}-tasks`;
        const taskList = taskCategories[category];

        document.getElementById(loadingId).style.display = 'none';
        document.getElementById(tasksId).style.display = 'block';

        let html = '<div class="list-group">';

        taskList.forEach(taskName => {
            if (taskResults[taskName]) {
                const result = taskResults[taskName];
                html += renderTaskItem(taskName, result, category === 'benchmarks');
            }
        });

        html += '</div>';
        document.getElementById(tasksId).innerHTML = html;
    }

    function renderTaskItem(taskName, result, isBenchmark) {
        const statusIcon = getStatusIcon(result.status, result.exists);
        const statusClass = getStatusClass(result.status, result.exists);

        let details = '';
        if (result.gsm8k_accuracy !== null && result.gsm8k_accuracy !== undefined) {
            const accuracy = (result.gsm8k_accuracy * 100).toFixed(1);
            details += `<span class="badge bg-info text-dark me-2">GSM8K: ${accuracy}%</span>`;
        }
        if (result.runtime) {
            details += `<span class="badge bg-secondary">${result.runtime}</span>`;
        }

        let errorDetails = '';
        if (result.error) {
            errorDetails = `<div class="small text-muted mt-1"><i class="bi bi-exclamation-circle"></i> ${result.error}</div>`;
        }

        return `
            <div class="list-group-item ${statusClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${statusIcon} ${taskName}</h6>
                        ${details}
                        ${errorDetails}
                    </div>
                </div>
            </div>
        `;
    }

    function renderSanityResults(sanityResults, dateFormatted) {
        document.getElementById('sanity-loading').style.display = 'none';
        document.getElementById('sanity-tasks').style.display = 'block';

        if (!sanityResults || !sanityResults.model_results) {
            document.getElementById('sanity-tasks').innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> No sanity check results available for this date
                </div>
            `;
            return;
        }

        const modelResults = sanityResults.model_results;
        const modelCount = Object.keys(modelResults).length;
        const passedCount = Object.values(modelResults).filter(r => r.status === 'pass').length;
        const overallPass = passedCount > 1;

        let html = `
            <div class="mb-3">
                <strong>Overall: </strong>
                ${overallPass
                    ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Pass</span>'
                    : '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Failed</span>'}
                <small class="text-muted ms-2">${passedCount}/${modelCount} models passed</small>
            </div>
            <div class="list-group">
        `;

        // Model display names
        const modelNames = {
            'llama4': 'Llama-4-Maverick-17B-128E-Instruct-FP8',
            'QWEN-30B': 'Qwen3-30B-A3B-Thinking-2507',
            'GPT-OSS-120B': 'gpt-oss-120b-bf16',
            'GPT-OSS-20B': 'gpt-oss-20b-bf16'
        };

        for (const [modelKey, result] of Object.entries(modelResults)) {
            const displayName = modelNames[modelKey] || modelKey;
            const accuracy = (result.accuracy * 100).toFixed(1);
            const statusIcon = result.status === 'pass'
                ? '<i class="bi bi-check-circle-fill text-success"></i>'
                : '<i class="bi bi-x-circle-fill text-danger"></i>';
            const statusClass = result.status === 'pass' ? '' : 'list-group-item-danger';

            html += `
                <div class="list-group-item ${statusClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${statusIcon} ${displayName}</span>
                        <span class="badge bg-primary">GSM8K: ${accuracy}%</span>
                    </div>
                </div>
            `;
        }

        html += '</div>';
        document.getElementById('sanity-tasks').innerHTML = html;
    }

    function getStatusIcon(status, exists) {
        if (!exists) return '<i class="bi bi-skip-forward-fill text-secondary"></i>';
        if (status === 'pass') return '<i class="bi bi-check-circle-fill text-success"></i>';
        if (status === 'fail') return '<i class="bi bi-x-circle-fill text-danger"></i>';
        return '<i class="bi bi-question-circle-fill text-warning"></i>';
    }

    function getStatusClass(status, exists) {
        if (!exists) return '';
        if (status === 'pass') return 'list-group-item-success';
        if (status === 'fail') return 'list-group-item-danger';
        if (status === 'unknown') return 'list-group-item-warning';
        return '';
    }

    function getStatusBadge(status) {
        const badges = {
            'passed': '<span class="badge bg-success"><i class="bi bi-check-circle"></i> All Passed</span>',
            'failed': '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Failed</span>',
            'partial': '<span class="badge bg-warning"><i class="bi bi-dash-circle"></i> Partial</span>',
            'unknown': '<span class="badge bg-secondary"><i class="bi bi-question-circle"></i> Unknown</span>'
        };
        return badges[status] || badges['unknown'];
    }

    // Event listeners
    document.getElementById('dateSelect').addEventListener('change', function() {
        loadData(this.value);
    });

    // Load initial data
    loadData(document.getElementById('dateSelect').value);
</script>
{% endblock %}
